---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import { useTranslations } from '../../i18n/utils';
import { ArrowLeft, Clock } from 'lucide-react';
import ProjectLinker from '../ProjectLinker.astro';

interface Props {
  lang: 'es' | 'en';
}

const { lang } = Astro.props;
const t = useTranslations(lang);

const { data: posts } = await supabase
  .from('posts')
  .select('*')
  .order('created_at', { ascending: false });

const { data: allProjects } = await supabase.from('projects').select('*');

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};
---

<Layout title={`Posts - Oliver MartÃ­nez Haro`}>
  <div class="max-w-2xl mx-auto">
    <a href={lang === 'es' ? '/' : '/en'} class="inline-flex items-center gap-2 text-zinc-500 hover:text-white transition-colors mb-12 group">
      <ArrowLeft className="w-4 h-4 group-hover:-translate-x-1 transition-transform" />
      {lang === 'es' ? 'Volver' : 'Back'}
    </a>

    <h1 class="text-3xl font-bold uppercase mb-12 tracking-widest border-b border-zinc-800 pb-4">{t('nav.posts')}</h1>

    <div class="relative border-l border-zinc-800 ml-4 md:ml-6 space-y-12 pb-12">
        {posts?.map((post) => (
            <div class="relative pl-8 md:pl-12">
                {/* Timeline Dot */}
                <div class="absolute -left-[5px] top-2 w-2.5 h-2.5 bg-zinc-600 rounded-full ring-4 ring-zinc-950"></div>
                
                <div class="brutalist-card p-6">
                    <div class="flex items-center gap-2 text-xs text-zinc-500 mb-3 font-mono">
                        <Clock className="w-3 h-3" />
                        <time>{formatDate(post.created_at)}</time>
                    </div>

                    <p class="text-zinc-200 text-lg leading-relaxed whitespace-pre-wrap">
                        <ProjectLinker text={lang === 'es' ? post.content_es : post.content_en} projects={allProjects || []} />
                    </p>

                    {post.image_urls && post.image_urls.length > 0 && (
                        <div class={`grid gap-2 mt-4 ${post.image_urls.length > 1 ? 'grid-cols-2' : 'grid-cols-1'}`}>
                            {post.image_urls.map((url) => (
                                <img 
                                    src={url} 
                                    alt="Post attachment" 
                                    class="rounded-sm border border-zinc-800 w-full h-auto object-cover max-h-96" 
                                    loading="lazy"
                                />
                            ))}
                        </div>
                    )}
                </div>
            </div>
        ))}
    </div>
  </div>
</Layout>
